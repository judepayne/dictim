#!/usr/bin/env bash

set -eo pipefail

VERSION=$(cat resources/VERSION)
REPO_URL="https://github.com/judepayne/dictim"
SCOOP_REPO="https://github.com/judepayne/scoop-judepayne.git"

echo "Updating Scoop bucket for version $VERSION"

# Clone scoop bucket repository using token authentication
git clone https://${GITHUB_TOKEN}@github.com/judepayne/scoop-judepayne.git /tmp/scoop-judepayne
cd /tmp/scoop-judepayne

# Configure git
git config user.name "CircleCI"
git config user.email "jude@judep.org"

# Calculate SHA256 for Windows binary
WINDOWS_EXE_URL="$REPO_URL/releases/download/v$VERSION/dictim-$VERSION-windows-amd64.exe"
echo "Calculating SHA256 for Windows binary..."
WINDOWS_SHA256=$(curl -sL "$WINDOWS_EXE_URL" | sha256sum | cut -d' ' -f1)

# Update the manifest
cat > bucket/dictim.json << EOF
{
    "version": "$VERSION",
    "description": "Diagram-as-data library for converting between dictim syntax and D2 formats",
    "homepage": "https://github.com/judepayne/dictim",
    "license": "MIT",
    "url": "$WINDOWS_EXE_URL",
    "hash": "sha256:$WINDOWS_SHA256",
    "bin": "dictim.exe",
    "checkver": "github",
    "autoupdate": {
        "url": "https://github.com/judepayne/dictim/releases/download/v\$version/dictim-\$version-windows-amd64.exe"
    }
}
EOF

# Commit and push changes
git add bucket/dictim.json
git commit -m "Update dictim to version $VERSION"
git push origin main

echo "Scoop bucket updated successfully!"